<%= render partial: "decidim/elections/admin/elections/tabs_menu" %>

<% survey_title = configured_survey.present? ? translated_attribute(configured_survey.questionnaire.title) : "" %>
<% add_decidim_page_title("#{t(".title")}: #{survey_title}") %>

<div class="item_show__header">
  <h1 class="item_show__header-title">
    <%= t(".title") %><% if configured_survey.present? %>: <%= survey_title %><% end %>
    <%= link_to t(".change_survey"), new_election_survey_import_path(election), class: "button button__sm button__transparent-secondary" %>
  </h1>
</div>

<% if @responses.any? %>
  <% valid_responses = @responses.select { |r| r[:status] == :valid } %>
  <% invalid_count = @responses.count { |r| r[:status] != :valid } %>

  <div class="mb-4">
    <% stats_content = capture do %>
      <div class="flex gap-4 items-center flex-wrap">
        <span class="badge badge--success"><%= t(".ready_to_import") %>: <%= valid_responses.count %></span>
        <% if invalid_count > 0 %>
          <span class="badge badge--muted"><%= t(".skipped") %>: <%= invalid_count %></span>
        <% end %>
      </div>
    <% end %>
    <%= cell("decidim/announcement", stats_content, callout_class: "secondary") %>
  </div>

  <% if valid_responses.any? %>
    <% page = (params[:page] || 1).to_i %>
    <% per_page = 25 %>
    <% paginated_responses = valid_responses.slice((page - 1) * per_page, per_page) || [] %>
    <% total_pages = (valid_responses.count.to_f / per_page).ceil %>

    <div class="table-stacked mb-6">
      <table class="table-list">
        <thead>
          <tr>
            <% census_columns.each do |column| %>
              <th><%= column["name"] %></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% paginated_responses.each do |response| %>
            <tr>
              <% census_columns.each do |column| %>
                <td><%= response[:census_data][column["name"]] || "-" %></td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <% if total_pages > 1 %>
      <nav class="pagination mb-6">
        <% if page > 1 %>
          <%= link_to "← #{t(".previous")}", election_survey_imports_path(election, page: page - 1), class: "pagination__item" %>
        <% end %>
        <span class="pagination__item pagination__item--current"><%= page %> / <%= total_pages %></span>
        <% if page < total_pages %>
          <%= link_to "#{t(".next")} →", election_survey_imports_path(election, page: page + 1), class: "pagination__item" %>
        <% end %>
      </nav>
    <% end %>

    <%= form_tag import_election_survey_imports_path(election), method: :post do %>
      <div class="item__edit-sticky">
        <div class="item__edit-sticky-container">
          <%= submit_tag t(".import_count", count: valid_responses.count), class: "button button__sm button__secondary" %>
          <%= link_to t(".cancel"), election_census_updates_path(election), class: "button button__sm button__transparent-secondary" %>
        </div>
      </div>
    <% end %>
  <% else %>
    <%= cell("decidim/announcement", t(".no_valid_entries"), callout_class: "warning") %>
    <div class="mt-4">
      <%= link_to t(".back_to_census"), election_census_updates_path(election), class: "button button__sm button__secondary" %>
    </div>
  <% end %>
<% else %>
  <%= cell("decidim/announcement", t(".no_responses"), callout_class: "warning") %>
  <div class="mt-4">
    <%= link_to t(".back_to_census"), election_census_updates_path(election), class: "button button__sm button__secondary" %>
  </div>
<% end %>
