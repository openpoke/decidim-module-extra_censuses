<% append_javascript_pack_tag "decidim_extra_censuses" %>

<%
  current_columns = form.object.columns.presence || form.object.persisted_columns
  columns_configured = current_columns.any?
  has_voters = census_count(election).positive?
  form_prefix = form.object_name
  column_types_options = custom_csv_column_types_options
%>

<template id="column-row-template">
  <%= render "decidim/elections/admin/censuses/column_row", column_types_options: column_types_options %>
</template>

<% if has_voters %>
  <div class="row column">
    <div class="callout secondary mb-4">
      <div class="font-semibold mb-1"><%= t(".current_configuration") %></div>
      <div class="text-sm"><%= format_custom_csv_columns(current_columns) %></div>
    </div>
  </div>

  <div class="row column mb-4 font-semibold border p-4 rounded w-1/2">
    <%= form.check_box :remove_all, help_text: t(".remove_before_upload") %>
  </div>

<% elsif columns_configured %>
  <div data-controller="custom-csv-census"
       data-custom-csv-census-form-prefix-value="<%= form_prefix %>"
       data-custom-csv-census-configured-value="true"
       data-custom-csv-census-button-text-value="<%= t(".save_configuration") %>">
    <div class="row column">
      <div class="callout secondary mb-4 flex justify-between items-start gap-4">
        <div>
          <div class="font-semibold mb-1"><%= t(".current_configuration") %></div>
          <div class="text-sm"><%= format_custom_csv_columns(current_columns) %></div>
        </div>
        <button type="button"
                data-action="click->custom-csv-census#toggleEdit"
                class="button button__xs button__transparent-secondary"
                title="<%= t(".edit_columns") %>">
          <%= icon "pencil-line" %>
        </button>
      </div>

      <div data-custom-csv-census-target="editorSection" class="hidden mb-6">
        <div class="font-semibold text-lg mb-4"><%= t(".census_attributes") %></div>
        <div data-custom-csv-census-target="columnsList" class="mb-4">
          <% current_columns.each do |col| %>
            <%= render "decidim/elections/admin/censuses/column_row", column_types_options: column_types_options, column_name: col["name"] || col[:name], column_type: col["column_type"] || col[:column_type] %>
          <% end %>
        </div>
        <div class="flex gap-4 items-center mb-4">
          <button type="button"
                  data-action="click->custom-csv-census#addColumn"
                  class="button button__sm button__secondary">
            <%= t(".new_column") %>
          </button>
        </div>
        <div data-custom-csv-census-target="hiddenFields"></div>
      </div>

      <div data-custom-csv-census-target="uploadSection">
        <div class="row column font-semibold pb-4"><%= t(".upload_title") %></div>
        <div class="row column">
          <p class="mb-2"><%= t(".upload_description_html") %></p>
          <% column_names = current_columns.map { |c| c["name"] || c[:name] } %>
          <% example_values = column_names.each_with_index.map { |_, i| "value#{i + 1}" } %>
          <pre class="code-block"><%= column_names.join(";") %>
<%= example_values.join(";") %></pre>
        </div>
        <div class="row column">
          <div class="font-semibold">
            <%= form.upload :file,
                  button_label: t(".upload_file"),
                  help_i18n_scope: "decidim.admin.forms.file_help.import_csv",
                  button_class: "button button__sm button__transparent-secondary",
                  required: true %>
          </div>
        </div>
      </div>
    </div>
  </div>

<% else %>
  <div data-controller="custom-csv-census"
       data-custom-csv-census-form-prefix-value="<%= form_prefix %>"
       data-custom-csv-census-configured-value="false"
       data-custom-csv-census-button-text-value="<%= t(".save_configuration") %>">
    <div class="row column">
      <p class="mb-6"><%= t(".description") %></p>

      <div class="font-semibold text-lg mb-4"><%= t(".census_attributes") %></div>

      <div data-custom-csv-census-target="columnsList" class="mb-4">
        <%= render "decidim/elections/admin/censuses/column_row", column_types_options: column_types_options %>
      </div>

      <div class="flex gap-4 items-center">
        <button type="button"
                data-action="click->custom-csv-census#addColumn"
                class="button button__sm button__secondary">
          <%= t(".new_column") %>
        </button>
      </div>

      <div data-custom-csv-census-target="hiddenFields"></div>
    </div>
  </div>
<% end %>
